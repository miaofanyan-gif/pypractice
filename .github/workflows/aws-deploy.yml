# 工作流名称
name: SSH Deploy Python Project to AWS EC2

# 触发条件：推送到 main 分支时执行
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：签出仓库代码（GitHub Actions 运行环境）
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：配置 SSH 免密登录
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.AWS_HOST }} ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # 步骤3：SSH 登录 EC2 执行 Python 项目部署
      - name: Deploy pypractice to AWS EC2
        run: |
          ssh -p ${{ secrets.AWS_HOST }} ${{ secrets.AWS_USERNAME }}@${{ secrets.AWS_HOST }} << 'EOF'
            # 进入项目目录（你的指定路径）
            cd /home/ec2-user/www/pypractice
            
            # 拉取最新代码（确保服务器已关联 GitHub 仓库）
            git pull origin main
            
            # 安装/更新 Python 依赖（建议用虚拟环境，更安全）
            # 1. 检查并创建虚拟环境（首次部署需要）
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            # 2. 激活虚拟环境
            source venv/bin/activate
            # 3. 安装依赖（requirements.txt 是 Python 项目依赖文件）
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # 重启 Python 服务（两种常见方式，选其一即可）
            # 方式1：用 systemd 管理（推荐，需提前配置 service 文件）
            sudo systemctl restart pypractice
            
            # 方式2：用 supervisor 管理（如果用 supervisor）
            # sudo supervisorctl restart pypractice
            
            # 方式3：简单的后台运行（适合测试，不推荐生产）
            # nohup python3 app.py > app.log 2>&1 &
            
            # 可选：清理缓存
            # rm -rf __pycache__
          EOF